# Telegram Bot Deployment Guide

Complete deployment guide for the Instagram/TikTok downloader Telegram bot built with Laravel.

## ðŸ“‹ Table of Contents

1. [Prerequisites](#prerequisites)
2. [Installation](#installation)
3. [Configuration](#configuration)
4. [yt-dlp Installation](#yt-dlp-installation)
5. [Queue Setup](#queue-setup)
6. [Webhook Configuration](#webhook-configuration)
7. [Production Deployment](#production-deployment)
8. [Monitoring & Maintenance](#monitoring--maintenance)
9. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Server Requirements

- **PHP**: 8.2 or higher
- **Composer**: Latest version
- **Laravel**: 12.x
- **Database**: MySQL 8.0+, PostgreSQL 13+, or SQLite 3.35+
- **Queue Driver**: Redis (recommended) or Database
- **yt-dlp**: Latest version installed on system
- **Server**: Linux (Ubuntu 20.04+ recommended) with sufficient disk space

### System Dependencies

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y \
    php8.2-cli \
    php8.2-fpm \
    php8.2-mysql \
    php8.2-xml \
    php8.2-mbstring \
    php8.2-curl \
    php8.2-zip \
    php8.2-gd \
    composer \
    redis-server \
    python3 \
    python3-pip \
    ffmpeg
```

---

## Installation

### 1. Clone and Install Dependencies

```bash
# Navigate to your project directory
cd /path/to/your/project

# Install PHP dependencies
composer install --no-dev --optimize-autoloader

# Install Node dependencies (if needed)
npm install
npm run build
```

### 2. Environment Configuration

Copy the example environment file and configure it:

```bash
cp .env.example .env
php artisan key:generate
```

Edit `.env` file with your configuration (see [Configuration](#configuration) section).

### 3. Database Setup

```bash
# Run migrations
php artisan migrate --force

# If using database queue driver, ensure jobs table exists
php artisan queue:table
php artisan migrate
```

### 4. Storage Setup

```bash
# Create storage directories
mkdir -p storage/app/temp/downloads
chmod -R 775 storage
chown -R www-data:www-data storage
```

---

## Configuration

### Environment Variables

Edit your `.env` file with the following variables:

```env
# Application
APP_NAME="Telegram Downloader Bot"
APP_ENV=production
APP_KEY=base64:... # Generated by php artisan key:generate
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=telegram_bot
DB_USERNAME=your_username
DB_PASSWORD=your_password

# Queue Configuration
QUEUE_CONNECTION=redis  # or 'database' if Redis is not available

# Redis (if using Redis queue)
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
REDIS_QUEUE_CONNECTION=default
REDIS_QUEUE=default
REDIS_QUEUE_RETRY_AFTER=90

# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_API_URL=https://api.telegram.org/bot
TELEGRAM_WEBHOOK_SECRET=your_webhook_secret_optional

# Download Settings
DOWNLOAD_TIMEOUT=60
YT_DLP_PATH=yt-dlp
```

### Getting Your Telegram Bot Token

1. Open Telegram and search for [@BotFather](https://t.me/botfather)
2. Send `/newbot` command
3. Follow the instructions to create your bot
4. Copy the bot token provided
5. Add it to your `.env` file as `TELEGRAM_BOT_TOKEN`

---

## yt-dlp Installation

### Linux Installation

#### Method 1: Using pip (Recommended)

```bash
# Install yt-dlp
sudo pip3 install yt-dlp

# Or using pipx (isolated installation)
sudo pip3 install pipx
pipx ensurepath
pipx install yt-dlp

# Verify installation
yt-dlp --version
```

#### Method 2: Using Binary

```bash
# Download latest binary
sudo wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp
sudo chmod a+rx /usr/local/bin/yt-dlp

# Verify installation
yt-dlp --version
```

#### Method 3: Using Package Manager (Ubuntu/Debian)

```bash
# Add repository (if available)
sudo add-apt-repository ppa:yt-dlp/stable
sudo apt-get update
sudo apt-get install yt-dlp
```

### Update yt-dlp

```bash
# Using pip
sudo pip3 install -U yt-dlp

# Using binary
sudo yt-dlp -U
```

### Verify yt-dlp Works

```bash
# Test with a public Instagram post
yt-dlp --version

# Test download (optional)
yt-dlp "https://www.instagram.com/p/example/" --dry-run
```

---

## Queue Setup

### Option 1: Redis Queue (Recommended)

#### Install Redis

```bash
# Ubuntu/Debian
sudo apt-get install redis-server

# Start Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server

# Verify Redis is running
redis-cli ping
# Should return: PONG
```

#### Configure Laravel

In your `.env`:
```env
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

#### Start Queue Worker

```bash
# Development
php artisan queue:work --tries=2 --timeout=60

# Production (with supervisor - see below)
```

### Option 2: Database Queue

#### Configure Laravel

In your `.env`:
```env
QUEUE_CONNECTION=database
```

#### Start Queue Worker

```bash
php artisan queue:work database --tries=2 --timeout=60
```

### Supervisor Configuration (Production)

Create supervisor configuration file:

```bash
sudo nano /etc/supervisor/conf.d/telegram-bot-worker.conf
```

Add the following:

```ini
[program:telegram-bot-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/project/artisan queue:work redis --sleep=3 --tries=2 --max-time=3600 --timeout=60
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/your/project/storage/logs/worker.log
stopwaitsecs=3600
```

Reload and start supervisor:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start telegram-bot-worker:*
```

Check status:

```bash
sudo supervisorctl status
```

---

## Webhook Configuration

### Set Webhook URL

Replace `YOUR_BOT_TOKEN` and `YOUR_DOMAIN` with your actual values:

```bash
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://YOUR_DOMAIN.com/api/telegram/webhook",
    "allowed_updates": ["message"]
  }'
```

### Verify Webhook

```bash
curl "https://api.telegram.org/botYOUR_BOT_TOKEN/getWebhookInfo"
```

### Remove Webhook (if needed)

```bash
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/deleteWebhook"
```

### Web Server Configuration

#### Nginx Configuration

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com;
    root /path/to/your/project/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

#### Apache Configuration

Ensure `.htaccess` is enabled and mod_rewrite is active:

```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    DocumentRoot /path/to/your/project/public

    <Directory /path/to/your/project/public>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

---

## Production Deployment

### 1. Optimize Application

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer install --no-dev --optimize-autoloader
```

### 2. Set Permissions

```bash
# Set ownership
sudo chown -R www-data:www-data /path/to/your/project

# Set permissions
sudo find /path/to/your/project -type f -exec chmod 644 {} \;
sudo find /path/to/your/project -type d -exec chmod 755 {} \;

# Storage and cache directories
sudo chmod -R 775 /path/to/your/project/storage
sudo chmod -R 775 /path/to/your/project/bootstrap/cache
```

### 3. SSL Certificate (HTTPS Required for Webhooks)

```bash
# Using Let's Encrypt (Certbot)
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

### 4. Firewall Configuration

```bash
# Allow HTTP and HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable
```

### 5. Cron Job Setup

Add Laravel scheduler to crontab:

```bash
sudo crontab -e -u www-data
```

Add:

```
* * * * * cd /path/to/your/project && php artisan schedule:run >> /dev/null 2>&1
```

---

## Monitoring & Maintenance

### Log Files

Monitor application logs:

```bash
# Laravel logs
tail -f storage/logs/laravel.log

# Queue worker logs (if using supervisor)
tail -f storage/logs/worker.log
```

### Queue Monitoring

```bash
# Check queue status
php artisan queue:monitor

# View failed jobs
php artisan queue:failed

# Retry failed jobs
php artisan queue:retry all
```

### Disk Space Monitoring

```bash
# Check disk usage
df -h

# Clean old temporary files (if any remain)
find storage/app/temp -type f -mtime +1 -delete
```

### Update yt-dlp Regularly

```bash
# Add to crontab for weekly updates
0 2 * * 0 sudo pip3 install -U yt-dlp
```

---

## Troubleshooting

### Bot Not Responding

1. **Check webhook status:**
   ```bash
   curl "https://api.telegram.org/botYOUR_BOT_TOKEN/getWebhookInfo"
   ```

2. **Check queue worker:**
   ```bash
   sudo supervisorctl status
   ```

3. **Check logs:**
   ```bash
   tail -f storage/logs/laravel.log
   ```

### Downloads Failing

1. **Verify yt-dlp installation:**
   ```bash
   yt-dlp --version
   ```

2. **Test yt-dlp manually:**
   ```bash
   yt-dlp "https://www.instagram.com/p/example/" --dry-run
   ```

3. **Check disk space:**
   ```bash
   df -h
   ```

4. **Check permissions:**
   ```bash
   ls -la storage/app/temp/downloads
   ```

### Queue Jobs Failing

1. **Check failed jobs:**
   ```bash
   php artisan queue:failed
   ```

2. **View job details:**
   ```bash
   php artisan queue:failed-table
   ```

3. **Retry failed jobs:**
   ```bash
   php artisan queue:retry all
   ```

### High Memory Usage

1. **Restart queue workers:**
   ```bash
   sudo supervisorctl restart telegram-bot-worker:*
   ```

2. **Limit concurrent jobs:**
   Edit supervisor config and reduce `numprocs`

### Timeout Issues

1. **Increase timeout in config:**
   Edit `config/telegram.php`:
   ```php
   'download_timeout' => 120, // Increase from 60 to 120
   ```

2. **Update job timeout:**
   Edit `app/Jobs/DownloadMediaJob.php`:
   ```php
   public int $timeout = 120;
   ```

---

## Security Checklist

- [ ] `APP_DEBUG=false` in production
- [ ] Strong `APP_KEY` generated
- [ ] Secure database credentials
- [ ] HTTPS enabled for webhook
- [ ] Firewall configured
- [ ] File permissions set correctly
- [ ] Regular security updates
- [ ] Bot token kept secret
- [ ] Webhook secret configured (optional but recommended)

---

## Support

For issues or questions:

1. Check logs: `storage/logs/laravel.log`
2. Review this documentation
3. Check Laravel and yt-dlp documentation
4. Verify all services are running

---

## License

This project is open-sourced software licensed under the MIT license.
